<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lounge | Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b0b0b;
            color: #e4e4e7;
            height: 100vh;
            overflow: hidden;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }

        .sidebar-item {
            transition: all 0.2s ease;
            border-radius: 12px;
        }
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }

        .chat-bubble {
            max-width: 80%;
            border-radius: 18px;
            padding: 12px 16px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
        }

        .rank-badge {
            font-size: 10px;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .rank-dev { background: #4f46e5; color: white; }
        .rank-owner { background: #ef4444; color: white; }
        .rank-member { background: #3f3f46; color: #a1a1aa; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-overlay.active { display: flex; }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #0b0b0b;
        }

        .pfp-editable {
            position: relative;
            cursor: pointer;
        }
        .pfp-editable::after {
            content: 'CHANGE';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 800;
            opacity: 0;
            transition: 0.2s;
            border-radius: inherit;
        }
        .pfp-editable:hover::after { opacity: 1; }
    </style>
</head>
<body class="flex p-4 gap-4 h-screen">

    <!-- Left Sidebar -->
    <aside class="w-72 bg-[#121212] border border-zinc-800/50 rounded-3xl flex flex-col overflow-hidden">
        <div class="p-6 border-b border-zinc-800/50">
            <h1 class="text-xl font-800 italic tracking-tighter text-white">LOUNGE.</h1>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-6">
            <div>
                <h3 class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest px-2 mb-4">Users Online â€” <span id="online-count">0</span></h3>
                <div id="online-list" class="space-y-1"></div>
            </div>
            <div>
                <h3 class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest px-2 mb-4">Offline</h3>
                <div id="offline-list" class="space-y-1 opacity-50"></div>
            </div>
        </div>

        <!-- My Profile Bottom Left -->
        <div class="p-4 bg-[#18181b] border-t border-zinc-800/50">
            <div onclick="openProfile(myProfile.username)" class="flex items-center gap-3 p-2 hover:bg-white/5 rounded-xl cursor-pointer transition-all group">
                <div class="relative">
                    <img id="my-sidebar-pfp" src="" class="w-10 h-10 rounded-full object-cover border border-zinc-700">
                    <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-[#18181b] rounded-full"></div>
                </div>
                <div class="flex-1 overflow-hidden">
                    <p id="my-sidebar-name" class="text-sm font-bold text-white truncate">Loading...</p>
                    <p class="text-[10px] text-zinc-500 font-medium">Click to edit</p>
                </div>
                <svg class="w-4 h-4 text-zinc-600 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </div>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col bg-[#121212] border border-zinc-800/50 rounded-3xl overflow-hidden">
        <header class="p-6 border-b border-zinc-800/50 flex justify-between items-center bg-[#141414]">
            <div>
                <h2 class="font-bold text-white">General Chat</h2>
                <p class="text-xs text-zinc-500">Welcome to the community</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openStaffList()" class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-xl text-xs font-bold transition-all">Staff</button>
                <button onclick="logout()" class="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-xl text-xs font-bold transition-all">Exit</button>
            </div>
        </header>

        <div id="chat-scroller" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar">
            <div id="message-container"></div>
        </div>

        <div class="p-6">
            <form id="chat-form" class="bg-zinc-900/50 border border-zinc-800 rounded-2xl flex items-center p-2 gap-2">
                <input type="file" id="file-input" class="hidden">
                <button type="button" onclick="document.getElementById('file-input').click()" class="p-3 text-zinc-500 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                </button>
                <input type="text" id="msg-input" placeholder="Type a message..." class="flex-1 bg-transparent border-none text-sm py-2 focus:ring-0">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-xl text-sm font-bold transition-all">Send</button>
            </form>
        </div>
    </main>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal-overlay">
        <div class="bg-[#18181b] w-full max-w-md rounded-[2.5rem] overflow-hidden border border-zinc-800 shadow-2xl">
            <div id="p-banner" class="h-32 bg-indigo-900 bg-cover bg-center"></div>
            <div class="px-8 pb-8 text-center -mt-12">
                <div class="inline-block relative">
                    <img id="p-avatar" src="" class="w-24 h-24 rounded-3xl border-4 border-[#18181b] object-cover bg-zinc-800">
                    <input type="file" id="pfp-upload" class="hidden" accept="image/*">
                </div>
                
                <div id="p-view-mode" class="mt-4">
                    <h2 id="p-name" class="text-2xl font-bold text-white">Username</h2>
                    <div id="p-ranks" class="flex justify-center gap-2 mt-2"></div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-8">
                        <div class="bg-zinc-900 p-4 rounded-2xl border border-zinc-800">
                            <p class="text-[10px] font-bold text-zinc-500 uppercase">Identity</p>
                            <p id="p-identity" class="text-sm font-semibold mt-1">?? / ?</p>
                        </div>
                        <div class="bg-zinc-900 p-4 rounded-2xl border border-zinc-800">
                            <p class="text-[10px] font-bold text-zinc-500 uppercase">Likes</p>
                            <p id="p-likes" class="text-sm font-semibold mt-1 text-pink-500">0</p>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-6">
                        <button id="edit-profile-btn" class="flex-1 py-3 bg-zinc-800 hover:bg-zinc-700 rounded-2xl text-xs font-bold transition-all hidden">Edit Profile</button>
                        <button onclick="closeModal('profile-modal')" class="px-6 py-3 bg-zinc-800 hover:bg-red-500/20 hover:text-red-500 rounded-2xl text-xs font-bold transition-all">Close</button>
                    </div>
                </div>

                <div id="p-edit-mode" class="hidden mt-6 text-left space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-zinc-500 uppercase px-2">Username</label>
                        <input type="text" id="edit-username" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl p-3 text-sm mt-1">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-zinc-500 uppercase px-2">Age</label>
                            <input type="number" id="edit-age" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl p-3 text-sm mt-1">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-zinc-500 uppercase px-2">Gender</label>
                            <select id="edit-gender" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl p-3 text-sm mt-1">
                                <option>Male</option>
                                <option>Female</option>
                                <option>Other</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="saveProfile()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl text-sm font-bold shadow-lg shadow-indigo-600/20 transition-all">Update Identity</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Modal -->
    <div id="staff-modal" class="modal-overlay">
        <div class="bg-[#18181b] w-full max-w-2xl rounded-3xl overflow-hidden border border-zinc-800">
            <div class="p-6 border-b border-zinc-800 flex justify-between items-center">
                <h2 class="font-bold">Community Staff</h2>
                <button onclick="closeModal('staff-modal')" class="text-zinc-500">Close</button>
            </div>
            <div id="staff-list-container" class="p-6 grid grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const socket = io();
        
        // --- Unique Client Logic ---
        let clientId = localStorage.getItem('lounge_cid');
        if (!clientId) {
            clientId = 'cl-' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('lounge_cid', clientId);
        }

        let myProfile = JSON.parse(localStorage.getItem('chat_profile')) || {
            username: 'Guest' + Math.floor(Math.random() * 9999),
            clientId: clientId,
            avatar: '',
            age: 18,
            gender: 'Male',
            likes: 0
        };

        let onlineUsers = [];
        let globalRegistry = JSON.parse(localStorage.getItem('lounge_registry') || '[]');

        const RANKS = [
            { name: 'Dev', keys: ['dev'], class: 'rank-dev' },
            { name: 'Owner', keys: ['owner', 'ceo'], class: 'rank-owner' },
            { name: 'Member', keys: [], class: 'rank-member' }
        ];

        function getPfp(user) {
            return user?.avatar || `https://ui-avatars.com/api/?name=${user?.username}&background=3f3f46&color=fff&bold=true`;
        }

        function getRank(name) {
            const low = name.toLowerCase();
            for (const r of RANKS) {
                if (r.keys.some(k => low.includes(k))) return r;
            }
            return RANKS[2];
        }

        // --- Profile UI Updates ---
        function updateMyLocalUI() {
            document.getElementById('my-sidebar-name').innerText = myProfile.username;
            document.getElementById('my-sidebar-pfp').src = getPfp(myProfile);
        }

        function openProfile(name) {
            const user = globalRegistry.find(u => u.username === name) || onlineUsers.find(u => u.username === name) || { username: name };
            const isMe = user.clientId === myProfile.clientId || user.username === myProfile.username;

            document.getElementById('p-name').innerText = user.username;
            document.getElementById('p-avatar').src = getPfp(user);
            document.getElementById('p-identity').innerText = `${user.age || '??'} / ${user.gender || '?'}`;
            document.getElementById('p-likes').innerText = user.likes || 0;
            
            const rank = getRank(user.username);
            document.getElementById('p-ranks').innerHTML = `<span class="rank-badge ${rank.class}">${rank.name}</span>`;

            document.getElementById('edit-profile-btn').classList.toggle('hidden', !isMe);
            document.getElementById('edit-profile-btn').onclick = () => toggleEdit(true);
            
            // Handle PFP upload trigger
            document.getElementById('p-avatar').onclick = () => isMe && document.getElementById('pfp-upload').click();
            document.getElementById('pfp-upload').onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (ev) => {
                    myProfile.avatar = ev.target.result;
                    document.getElementById('p-avatar').src = ev.target.result;
                };
                reader.readAsDataURL(file);
            };

            toggleEdit(false);
            document.getElementById('profile-modal').classList.add('active');
        }

        function toggleEdit(show) {
            document.getElementById('p-view-mode').classList.toggle('hidden', show);
            document.getElementById('p-edit-mode').classList.toggle('hidden', !show);
            document.getElementById('p-avatar').classList.toggle('pfp-editable', show);
            if(show) {
                document.getElementById('edit-username').value = myProfile.username;
                document.getElementById('edit-age').value = myProfile.age;
                document.getElementById('edit-gender').value = myProfile.gender;
            }
        }

        function saveProfile() {
            const newName = document.getElementById('edit-username').value.trim();
            if(!newName) return;

            myProfile.username = newName;
            myProfile.age = document.getElementById('edit-age').value;
            myProfile.gender = document.getElementById('edit-gender').value;

            localStorage.setItem('chat_profile', JSON.stringify(myProfile));
            socket.emit('updateProfile', myProfile); // Tell server we changed
            
            updateMyLocalUI();
            openProfile(myProfile.username);
        }

        // --- Core Socket Events ---
        socket.on('message', (msg) => {
            const container = document.getElementById('message-container');
            const div = document.createElement('div');
            const isMe = msg.clientId === myProfile.clientId;

            div.className = `flex gap-4 mb-4 ${isMe ? 'flex-row-reverse' : ''}`;
            div.innerHTML = `
                <img src="${getPfp(msg)}" onclick="openProfile('${msg.username}')" class="w-9 h-9 rounded-full cursor-pointer object-cover">
                <div class="flex flex-col ${isMe ? 'items-end' : ''}">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-[10px] font-bold text-zinc-500 uppercase">${msg.username}</span>
                    </div>
                    <div class="chat-bubble ${isMe ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-zinc-800 text-zinc-200 rounded-tl-none'}">
                        ${msg.text}
                    </div>
                </div>
            `;
            container.appendChild(div);
            document.getElementById('chat-scroller').scrollTop = document.getElementById('chat-scroller').scrollHeight;
        });

        socket.on('userListUpdate', (users) => {
            onlineUsers = users;
            document.getElementById('online-count').innerText = users.length;

            // Update my local object if I'm in the list (keeps me synced with server view)
            const meInList = users.find(u => u.clientId === clientId);
            if (meInList) {
                myProfile = {...myProfile, ...meInList};
                updateMyLocalUI();
            }

            // Sync Registry
            users.forEach(u => {
                const idx = globalRegistry.findIndex(r => r.clientId === u.clientId);
                if (idx > -1) globalRegistry[idx] = u;
                else globalRegistry.push(u);
            });
            localStorage.setItem('lounge_registry', JSON.stringify(globalRegistry));

            // Render Sidebar Online
            document.getElementById('online-list').innerHTML = users.map(u => `
                <div onclick="openProfile('${u.username}')" class="flex items-center gap-3 p-2 sidebar-item cursor-pointer">
                    <img src="${getPfp(u)}" class="w-8 h-8 rounded-full object-cover">
                    <div class="flex-1 overflow-hidden">
                        <p class="text-xs font-semibold text-zinc-300 truncate">${u.username}</p>
                    </div>
                    <div class="status-indicator bg-green-500"></div>
                </div>
            `).join('');

            // Render Sidebar Offline
            const off = globalRegistry.filter(r => !users.some(u => u.clientId === r.clientId));
            document.getElementById('offline-list').innerHTML = off.map(u => `
                <div onclick="openProfile('${u.username}')" class="flex items-center gap-3 p-2 sidebar-item cursor-pointer">
                    <img src="${getPfp(u)}" class="w-8 h-8 rounded-full grayscale object-cover">
                    <p class="text-xs font-semibold text-zinc-500 truncate">${u.username}</p>
                </div>
            `).join('');
        });

        function openStaffList() {
            const staff = globalRegistry.filter(u => getRank(u.username).name !== 'Member');
            document.getElementById('staff-list-container').innerHTML = staff.map(u => `
                <div class="bg-zinc-900 p-4 rounded-2xl border border-zinc-800 flex items-center gap-3">
                    <img src="${getPfp(u)}" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="text-sm font-bold">${u.username}</p>
                        <span class="rank-badge ${getRank(u.username).class}">${getRank(u.username).name}</span>
                    </div>
                </div>
            `).join('');
            document.getElementById('staff-modal').classList.add('active');
        }

        document.getElementById('chat-form').onsubmit = (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            if (!input.value.trim()) return;
            socket.emit('sendMessage', { ...myProfile, text: input.value });
            input.value = '';
        };

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function logout() { localStorage.clear(); window.location.reload(); }

        // Join
        socket.emit('join', myProfile);
        updateMyLocalUI();
    </script>
</body>
</html>
